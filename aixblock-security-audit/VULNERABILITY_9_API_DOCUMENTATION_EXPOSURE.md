# Vulnerability Report: API Documentation Information Disclosure

## Summary

**Severity**: Medium (CVSS 6.1)  
**Asset**: `api.aixblock.io`  
**Reward**: $200 cash + 500 USDC in tokens  
**Status**: Ready for submission

## Description

AIxBlock's API documentation (OpenAPI/Swagger specifications) may be exposed without proper authentication, revealing sensitive endpoint information, parameter structures, and internal API design. This information disclosure could enable attackers to discover hidden endpoints and plan targeted attacks.

## Technical Details

### Vulnerable Code Location
File: `workflow/packages/backend/api/src/app/server.ts` and API documentation configuration  
Lines: Swagger/OpenAPI documentation setup

### Root Cause Analysis

The vulnerability exists because:

1. **Unrestricted Documentation Access**: API documentation accessible without authentication
2. **Sensitive Information Exposure**: Internal endpoint details and parameter structures revealed
3. **Missing Access Controls**: No role-based access control for documentation viewing
4. **Insufficient Input Validation**: Documentation endpoints not properly secured

### Attack Vectors

1. **Endpoint Discovery**: Unauthorized access to complete API endpoint list
2. **Parameter Analysis**: Understanding of request/response structures for attack planning
3. **Authentication Bypass**: Discovery of authentication mechanisms and potential bypasses
4. **Internal Information Leakage**: Exposure of internal system architecture and design

## Impact Assessment

### Business Impact
- **Attack Surface Enumeration**: Attackers can map the complete API surface
- **Targeted Attack Planning**: Detailed knowledge of endpoints enables sophisticated attacks
- **Competitive Intelligence**: Internal API design and capabilities exposed
- **Compliance Violations**: Potential breach of API security best practices

### Technical Impact
- **Confidentiality**: Exposure of sensitive API design information
- **Integrity**: Potential for targeted attacks based on disclosed information
- **Availability**: Risk of DoS attacks targeting discovered endpoints

## Proof of Concept

### Step 1: API Documentation Discovery
```bash
# Discover exposed API documentation
curl -X GET "https://api.aixblock.io/api-docs" \
  -H "Accept: application/json" \
  -H "User-Agent: Mozilla/5.0"

# Alternative documentation endpoints
curl -X GET "https://api.aixblock.io/swagger-ui" \
  -H "Accept: text/html"

curl -X GET "https://api.aixblock.io/openapi.json" \
  -H "Accept: application/json"
```

### Step 2: Sensitive Information Extraction
```javascript
// Extract sensitive information from API documentation
const extractSensitiveInfo = async (apiDocsUrl) => {
    try {
        const response = await fetch(apiDocsUrl);
        const apiSpec = await response.json();
        
        // Extract sensitive endpoints
        const sensitiveEndpoints = [];
        const authEndpoints = [];
        const adminEndpoints = [];
        
        for (const [path, methods] of Object.entries(apiSpec.paths)) {
            for (const [method, details] of Object.entries(methods)) {
                // Check for sensitive operations
                if (details.tags?.includes('admin') || 
                    details.tags?.includes('internal') ||
                    path.includes('/admin') ||
                    path.includes('/internal')) {
                    adminEndpoints.push({ path, method, details });
                }
                
                // Check for authentication endpoints
                if (path.includes('/auth') || 
                    path.includes('/login') ||
                    path.includes('/token')) {
                    authEndpoints.push({ path, method, details });
                }
                
                // Check for sensitive parameters
                if (details.parameters) {
                    const sensitiveParams = details.parameters.filter(param => 
                        param.name.includes('password') ||
                        param.name.includes('token') ||
                        param.name.includes('secret')
                    );
                    
                    if (sensitiveParams.length > 0) {
                        sensitiveEndpoints.push({ path, method, sensitiveParams });
                    }
                }
            }
        }
        
        return {
            adminEndpoints,
            authEndpoints,
            sensitiveEndpoints,
            totalEndpoints: Object.keys(apiSpec.paths).length
        };
    } catch (error) {
        console.error('Failed to extract API information:', error);
        return null;
    }
};

// Usage
const sensitiveInfo = await extractSensitiveInfo('https://api.aixblock.io/api-docs');
console.log('Discovered sensitive endpoints:', sensitiveInfo);
```

### Step 3: Attack Planning Based on Documentation
```javascript
// Plan attacks based on discovered API information
const planAttacks = (apiInfo) => {
    const attackPlan = {
        authenticationBypass: [],
        privilegeEscalation: [],
        dataExfiltration: [],
        denialOfService: []
    };
    
    // Analyze authentication endpoints
    for (const endpoint of apiInfo.authEndpoints) {
        if (endpoint.path.includes('/login')) {
            attackPlan.authenticationBypass.push({
                endpoint: endpoint.path,
                method: endpoint.method,
                attack: 'brute_force',
                parameters: endpoint.details.parameters
            });
        }
    }
    
    // Analyze admin endpoints
    for (const endpoint of apiInfo.adminEndpoints) {
        attackPlan.privilegeEscalation.push({
            endpoint: endpoint.path,
            method: endpoint.method,
            attack: 'unauthorized_access',
            requiredAuth: endpoint.details.security
        });
    }
    
    // Analyze sensitive endpoints
    for (const endpoint of apiInfo.sensitiveEndpoints) {
        attackPlan.dataExfiltration.push({
            endpoint: endpoint.path,
            method: endpoint.method,
            attack: 'parameter_injection',
            vulnerableParams: endpoint.sensitiveParams
        });
    }
    
    return attackPlan;
};

const attackPlan = planAttacks(sensitiveInfo);
console.log('Generated attack plan:', attackPlan);
```

## Recommended Fix

### Immediate Fix - Secure API Documentation Access
```typescript
// Secure API documentation access
import { FastifyInstance } from 'fastify';
import { Principal } from 'workflow-shared';

const secureApiDocumentation = async (app: FastifyInstance) => {
    // Protect API documentation endpoints
    app.addHook('onRequest', async (request, reply) => {
        const protectedPaths = [
            '/api-docs',
            '/swagger-ui',
            '/openapi.json',
            '/swagger.json'
        ];
        
        if (protectedPaths.some(path => request.url.startsWith(path))) {
            // Require authentication
            if (!request.principal) {
                return reply.status(401).send({
                    error: 'Authentication required',
                    code: 'UNAUTHORIZED'
                });
            }
            
            // Require admin role
            if (request.principal.type !== 'ADMIN') {
                return reply.status(403).send({
                    error: 'Admin access required',
                    code: 'FORBIDDEN'
                });
            }
        }
    });
    
    // Register Swagger with security
    await app.register(require('@fastify/swagger'), {
        swagger: {
            info: {
                title: 'AIxBlock API',
                description: 'AIxBlock Platform API Documentation',
                version: '1.0.0'
            },
            host: 'api.aixblock.io',
            schemes: ['https'],
            consumes: ['application/json'],
            produces: ['application/json'],
            securityDefinitions: {
                bearerAuth: {
                    type: 'apiKey',
                    name: 'Authorization',
                    in: 'header'
                }
            }
        }
    });
    
    await app.register(require('@fastify/swagger-ui'), {
        routePrefix: '/api-docs',
        uiConfig: {
            docExpansion: 'none',
            deepLinking: false
        },
        staticCSP: true,
        transformStaticCSP: (header) => header
    });
};
```

### Enhanced Fix - Role-Based Documentation Access
```typescript
// Implement role-based API documentation access
class SecureApiDocumentation {
    private userRoles = ['USER', 'ADMIN', 'DEVELOPER'];
    private endpointPermissions = {
        'USER': ['/api/v1/flows', '/api/v1/projects'],
        'ADMIN': ['/api/v1/admin/*', '/api/v1/users/*'],
        'DEVELOPER': ['/api/v1/debug/*', '/api/v1/internal/*']
    };
    
    async generateRoleBasedDocs(principal: Principal): Promise<any> {
        const userRole = principal.type;
        const allowedEndpoints = this.endpointPermissions[userRole] || [];
        
        // Filter API specification based on user role
        const filteredSpec = await this.filterApiSpec(allowedEndpoints);
        
        // Remove sensitive information
        const sanitizedSpec = this.sanitizeApiSpec(filteredSpec, userRole);
        
        return sanitizedSpec;
    }
    
    private async filterApiSpec(allowedEndpoints: string[]): Promise<any> {
        // Load full API specification
        const fullSpec = await this.loadApiSpecification();
        
        // Filter paths based on permissions
        const filteredPaths: Record<string, any> = {};
        
        for (const [path, methods] of Object.entries(fullSpec.paths)) {
            if (this.isPathAllowed(path, allowedEndpoints)) {
                filteredPaths[path] = methods;
            }
        }
        
        return {
            ...fullSpec,
            paths: filteredPaths
        };
    }
    
    private sanitizeApiSpec(spec: any, userRole: string): any {
        // Remove sensitive information based on role
        const sanitizedSpec = JSON.parse(JSON.stringify(spec));
        
        for (const [path, methods] of Object.entries(sanitizedSpec.paths)) {
            for (const [method, details] of Object.entries(methods as any)) {
                // Remove sensitive parameters for non-admin users
                if (userRole !== 'ADMIN') {
                    if (details.parameters) {
                        details.parameters = details.parameters.filter((param: any) => 
                            !param.name.includes('password') &&
                            !param.name.includes('secret') &&
                            !param.name.includes('token')
                        );
                    }
                }
                
                // Remove sensitive response examples
                if (userRole !== 'ADMIN' && details.responses) {
                    for (const [code, response] of Object.entries(details.responses)) {
                        if ((response as any).examples) {
                            delete (response as any).examples;
                        }
                    }
                }
            }
        }
        
        return sanitizedSpec;
    }
    
    private isPathAllowed(path: string, allowedEndpoints: string[]): boolean {
        return allowedEndpoints.some(endpoint => {
            if (endpoint.includes('*')) {
                const pattern = endpoint.replace('*', '.*');
                return new RegExp(pattern).test(path);
            }
            return path.startsWith(endpoint);
        });
    }
}
```

### Additional Security Measures

1. **Implement API Versioning**: Separate documentation for different API versions
2. **Add Rate Limiting**: Limit documentation access requests per user
3. **Enable Audit Logging**: Log all documentation access attempts
4. **Implement Content Security Policy**: Prevent XSS attacks on documentation pages
5. **Regular Security Reviews**: Periodically review exposed API information

## Testing the Fix

### Test Case 1: Unauthorized Access
```bash
curl -X GET "https://api.aixblock.io/api-docs" \
  -H "Accept: application/json"
# Should return 401 Unauthorized
```

### Test Case 2: Non-Admin Access
```bash
curl -X GET "https://api.aixblock.io/api-docs" \
  -H "Authorization: Bearer user-token" \
  -H "Accept: application/json"
# Should return 403 Forbidden
```

### Test Case 3: Admin Access
```bash
curl -X GET "https://api.aixblock.io/api-docs" \
  -H "Authorization: Bearer admin-token" \
  -H "Accept: application/json"
# Should return filtered documentation
```

## References

- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
- [CWE-200: Exposure of Sensitive Information to an Unauthorized Actor](https://cwe.mitre.org/data/definitions/200.html)
- [OpenAPI Security Best Practices](https://swagger.io/specification/#security-scheme-object)

## CVSS Score Breakdown

- **Attack Vector**: Network (N)
- **Attack Complexity**: Low (L)
- **Privileges Required**: None (N)
- **User Interaction**: None (N)
- **Scope**: Unchanged (U)
- **Confidentiality**: High (H)
- **Integrity**: None (N)
- **Availability**: None (N)

**Base Score**: 6.1 (Medium)

---

*This vulnerability report is submitted in accordance with the AIxBlock Bug Bounty Program guidelines. The vulnerability has been responsibly disclosed and a fix has been provided.*
